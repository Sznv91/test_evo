# Soft-village Фискализатор
## Заметки:
### Смещение номера чека:
При закрытии/открытии смены происходит увеличение счетчика чека на 1 ед. После операции закрытия/открытия добавляется еще одна операция "Операция в ККМ". 
Итого:
 - Открытие смены: счетчик +2
 - Закрытие смены: счетчик +2
 
  ## Логика диспетчера печати:
  Для работы службы определены константы и переменная:
  
 - **printerAccess** (многопоточный boolean: AtomicBoolean). При запуске службы всегда является `true`. Информирует о доступности принтера. Является частью логики диспетчеризации печати.
 - **LATENCY_UPDATE_QUEUE** - время ожидания перед перезапуском потока проверки новых чеков в локальной БД.
 - **LATENCY_PRINT** - время ожидания перед перезапуском потока печати чеков из очереди `receiptQueue`.
 - **RETRY_AFTER_FAILED** - время ожидания перед переходом переменной printerAccess в состояние **true** после ошибки печати чека.

  При запуске службы формируется очередь печати (`receiptQueue` ArrayList). Данные берутся из БД, таблица `good_db`, `order_db`. Таблицы являются связанными, тип связи: 

> Один-ко-многим

В службе существуют два потока:

 - Поток для обновления очереди печати
 - Поток для запуска печати

 #### Поток для обновления очереди печати
 Для работы потока определена константа `LATENCY_UPDATE_QUEUE` которая указывает на время через которое произойдет повторная работа метода. Процедура обновления заключается в следующем:
 

 - Выполняется запрос из таблиц `good_db`, `order_db` сущности `OrderDbWithGoods` содержащей в себе информацию о чеке и товарах находящихся в чеке.
 - Поэлементная проверка наличия чеков полученных из БД с очередью печати `receiptQueue` : 
	 - В случае **наличия** чека в очереди - ничего не происходит;
	 - В случае **отсутствия** чека в очереди - происходит добавление в очередь печати `receiptQueue`.
 
#### Поток для запуска печати
Печать разделена на этапы:

1. Проверка авторизации пользователя.
Если пользователь **не авторизован** (После перезагрузки терминала не выбран пользователь), но ничего не происходит, если пользователь **авторизован**, то переход в следующему шагу.
2. Проверка размера очереди печати `receiptQueue`, если больше 0 то переход к следующему этапу.
3. Извлечение **первого** чека из очереди `receiptQueue`, и выполнение запроса к backend ресурсу (на данный момент `test_app/check_fiscal.php`), для проверки необходимости фискализации (Возможен сценарий фискализации чека на другом терминале, если текущий терминал долгое время был не в сети).
4. Получение ответа от backend:
	- **false**: нет необходимости фискализации - чек удаляется из очереди.
	- **true**: переход к следующему этапу.
5. Выполняется проверка доступности принтера в константе `printerAccess`. Если принтер доступен:
	- выполняется подготовка документов для печати (Выполняется расчет скидки, суммы, НДС и т.д. Документ формируется с использованием `EvotorApi`)
	- значение `printerAccess` изменяется на **`false`**
	- подготовленные документы отправляются на печать с помощью утильного метода `PrintUtil`. По окончании работы метода возвращается **CallBack** имеющий два состояния:  
		- printSuccess
		- printFailure

##### printSuccess
- Из очереди печати `receiptQueue` удаляется текущий чек.
- Из локальный БД выполняется удаление текущего чека, переменная `printerAccess` переводится в состояние **true**
##### printFailure
- Создается Handler с задержкой запуска равной **`RETRY_AFTER_FAILED`**, при выполнении handler'а значение переменной `printerAccess` переводится в состояние **true**